# CONTEXT.md — Pindamonhangaba Climate Visualization

> Reference document for the coding agent: conventions, domain knowledge, common errors, and gotchas.

---

## 1. Project-Specific Conventions

### Tech Stack (Frontend)
| Technology | Version | Purpose |
|------------|---------|--------|
| React | 18 | UI framework |
| Vite | 5+ | Build tooling |
| TypeScript | 5+ | Type safety (strict mode) |
| shadcn/ui | latest | Component library (Radix + Tailwind, code-owned) |
| Tailwind CSS | **4** | Utility-first CSS (CSS-first config, no tailwind.config.js) |
| D3.js | v7 | Complex visualizations |
| Recharts | 2+ | Simple charts |
| Framer Motion | 11+ | Animations (Motion library) |
| Scrollama | 3+ | Scrollytelling |
| Leaflet | 1.9+ | Interactive map |

### File Naming
- Python scripts: `snake_case.py`
- React components: `PascalCase.tsx`
- Hooks: `useCamelCase.ts`
- Utilities: `camelCase.ts`
- CSS files: `kebab-case.css`
- Data files: `snake_case.json` / `snake_case.csv`

### Directory Ownership
- `data/scripts/` — Python only. No JS here.
- `src/` — React/JS only. No Python here.
- `public/data/` — JSON files consumed by the frontend. Generated by Python scripts. Do NOT hand-edit.
- `data/raw/` — Raw API responses. Gitignored. Never commit.
- `data/processed/` — Cleaned CSVs. Gitignored. Never commit.

### Component Props Convention
- All visualization components accept a `data` prop as their primary data source.
- All components that need a year filter accept a `year` prop (number, e.g., `2024`).
- All components that need metric selection accept an `activeMetric` prop (string key).
- Callbacks are named `onXxx` (e.g., `onYearChange`, `onStepEnter`).

### Data Shape Contracts
```js
// Daily record (from climate_data.json)
{ date: "1985-01-15", temp_max: 32.1, temp_min: 18.4, temp_mean: 24.2,
  precipitation: 0.0, humidity: 65.3, wind_max: 12.1 }

// Annual metrics (from metrics.json, keyed by year)
{ hd30: 112, hd32: 45, tr20: 87, su25: 210, dtr_mean: 12.3,
  temp_max_mean: 28.4, temp_min_mean: 16.1, temp_mean_annual: 22.1,
  precip_total: 1234.5, precip_days: 98,
  hwdi_days: 18, hwdi_events: 3, hwdi_longest: 8,
  cdd: 42, gdd: 4521.3, p90_days: 36, p95_days: 18,
  first_hot_day: 45, last_hot_day: 320, hot_season_length: 275 }

// Summary (from summary.json)
{ hottest_day: {date, temp_max, temp_min},
  coldest_day: {date, temp_min},
  wettest_day: {date, precipitation},
  longest_heat_wave: {year, days},
  year_most_hd30: {year, hd30},
  hd30_trend_slope_per_decade: 8.2,
  decade_comparison: { "1940s": {...}, "2020s": {...} },
  temp_anomaly_by_year: { 1940: -0.4, ..., 2024: 1.2 } }
```

### CSS Conventions
- Use CSS custom properties from `variables.css` — never hardcode colors or spacing.
- Use Tailwind utility classes for layout (flex, grid, padding, margin).
- Use custom CSS for animations and complex visual effects.
- Never use inline styles except for D3-computed values (x, y, width, height, fill).

### Import Order (JS files)
1. React imports
2. Third-party libraries (d3, recharts, framer-motion)
3. Internal hooks
4. Internal components
5. Internal utils/constants
6. CSS imports (last)

---

## 2. Domain Knowledge

### Climate Metrics Definitions
| Metric | Full Name | Definition |
|--------|-----------|-----------|
| HD30 | Hot Days | Days where T_max ≥ 30°C |
| HD32 | Very Hot Days | Days where T_max ≥ 32°C |
| TR20 | Tropical Nights | Nights where T_min ≥ 20°C |
| SU25 | Summer Days | Days where T_max ≥ 25°C |
| DTR | Diurnal Temperature Range | Mean(T_max − T_min) per year |
| HWDI | Heat Wave Duration Index | Total days in sequences of ≥3 consecutive days with T_max > 32°C |
| CDD | Consecutive Dry Days | Max consecutive days with precipitation < 1mm |
| GDD | Growing Degree Days | SUM(MAX(0, (T_max+T_min)/2 − 10)) |
| P90 | 90th Percentile Days | Days above 90th percentile of historical T_max |
| P95 | 95th Percentile Days | Days above 95th percentile of historical T_max |

### Open-Meteo API
- **Base URL**: `https://archive-api.open-meteo.com/v1/archive`
- **Coordinates**: lat=-22.9250, lon=-45.4620 (Praça Monsenhor Marcondes, Pindamonhangaba)
- **Timezone**: Always use `America/Sao_Paulo` — otherwise dates shift by 3 hours
- **Date format**: `YYYY-MM-DD` (ISO 8601)
- **Rate limit**: ~10,000 calls/day on free tier
- **Response**: Instant JSON (no queue). If it hangs >10s, retry.
- **ERA5 data starts**: 1940-01-01 (earlier dates return empty or error)
- **Data lag**: Most recent ~5 days may be missing (reanalysis not yet finalized)

### ERA5 Reanalysis
- ERA5 is a **reanalysis** product — it combines historical observations with a climate model to fill gaps. It is NOT raw station data.
- Open-Meteo applies **elevation correction** to interpolate the ERA5 9km grid to the exact GPS coordinate. This is important for Pindamonhangaba's valley location.
- ERA5 temperatures may be **systematically 1–2°C lower** than ground station measurements in urban areas (no urban heat island in the model).
- Do NOT mix ERA5 data with INMET station data without bias correction.

### Pindamonhangaba Geography
- Located in the Paraíba Valley (Vale do Paraíba), São Paulo state, Brazil
- Altitude: ~550m above sea level (valley floor)
- Surrounded by Serra da Mantiqueira (north) and Serra do Mar (south)
- Valley topography creates temperature inversions — nights can be cooler than surrounding hills
- Urban area: ~170,000 inhabitants (2024)
- Climate classification: Cwa (humid subtropical, dry winter) per Köppen

### Temperature Thresholds (Brazil Context)
- **30°C** = commonly used "hot day" threshold in Brazilian public health literature
- **32°C** = threshold for heat stress in outdoor workers (NR-15 reference)
- **20°C T_min** = "tropical night" — uncomfortable for sleep without AC
- **25°C** = threshold for AC usage in residential buildings

### Color Scales
- **Climate Stripes**: Use Ed Hawkins' original palette. Baseline = mean of 1940–1980. Do NOT use a different baseline.
- **Temperature heatmap**: Use `d3.interpolateRdYlBu` reversed (blue=cold, red=hot). Domain: [10°C, 40°C].
- **Colorblind safety**: Always provide Viridis as an alternative. Never use red+green together as primary encoding.

---

## 3. Common Agent Errors

### Python Data Pipeline

**Error: API returns empty data for early years**
- Open-Meteo ERA5 archive starts at 1940-01-01. Requesting before this date returns an error or empty array.
- Fix: Clamp `start_date` to `max(start_date, '1940-01-01')`.

**Error: Missing days in DataFrame after merge**
- Open-Meteo returns only days with data. If a day is missing, it won't appear in the response.
- Fix: After merging, reindex to a full date range and interpolate.
  ```python
  full_index = pd.date_range('1940-01-01', '2024-12-31', freq='D')
  df = df.set_index('date').reindex(full_index).reset_index()
  df.rename(columns={'index': 'date'}, inplace=True)
  ```

**Error: T_min > T_max on some days**
- This happens occasionally in ERA5 reanalysis data (model artifact).
- Fix: Swap values when T_min > T_max. Log the occurrence.
  ```python
  mask = df['temp_min'] > df['temp_max']
  df.loc[mask, ['temp_min', 'temp_max']] = df.loc[mask, ['temp_max', 'temp_min']].values
  ```

**Error: `calculate_heat_waves` misses heat wave spanning year boundary**
- The function processes each year independently, so a heat wave from Dec 30 to Jan 3 is split.
- This is acceptable for annual metrics. Document this limitation in comments.

**Error: `gdd` calculation returns negative values**
- `MAX(0, ...)` must be applied before summing. A common mistake is summing first.
- Correct: `df['gdd_daily'] = np.maximum(0, (df['temp_max'] + df['temp_min'])/2 - 10)`

**Error: JSON file too large (>500KB)**
- Daily records for 85 years = ~31,000 rows. At ~100 bytes/row = ~3MB uncompressed.
- Fix: Round all floats to 1 decimal. Use short column names. Consider splitting by decade.
- If still >500KB: gzip compress. Vite serves `.gz` files automatically if configured.

**Error: `pd.to_datetime` fails on date strings**
- Open-Meteo returns dates as `"2024-01-15"` strings. Always specify `format='%Y-%m-%d'`.

### React / D3 Frontend

**Error: D3 chart doesn't update when props change**
- D3 mutates the DOM directly. React doesn't know about D3's changes.
- Fix: Use `useEffect` with the data as a dependency. Clear the SVG before re-drawing.
  ```js
  useEffect(() => {
    d3.select(svgRef.current).selectAll('*').remove(); // clear
    // ... draw
  }, [data, year]);
  ```

**Error: Leaflet map renders as grey box**
- Leaflet CSS must be imported. Missing CSS = no tiles rendered.
- Fix: Add `import 'leaflet/dist/leaflet.css'` in the component file.
- Also: Leaflet marker icons break with Vite. Fix:
  ```js
  import L from 'leaflet';
  import markerIcon from 'leaflet/dist/images/marker-icon.png';
  import markerShadow from 'leaflet/dist/images/marker-shadow.png';
  delete L.Icon.Default.prototype._getIconUrl;
  L.Icon.Default.mergeOptions({ iconUrl: markerIcon, shadowUrl: markerShadow });
  ```

**Error: Scrollama doesn't trigger on mobile**
- Scrollama requires the step elements to have a defined height.
- Fix: Set `min-height: 100vh` on each step div.

**Error: Recharts chart is invisible (0 width)**
- `<ResponsiveContainer>` needs a parent with explicit width/height.
- Fix: Wrap in a `<div style={{width: '100%', height: 400}}>`.

**Error: `useClimateData` fetches wrong path on GitHub Pages**
- On GitHub Pages, the base path is `/pindamonhangaba-climate/`. Relative paths like `./data/climate_data.json` resolve to the root.
- Fix: Use `import.meta.env.BASE_URL` from Vite:
  ```js
  const res = await fetch(`${import.meta.env.BASE_URL}data/climate_data.json`);
  ```

**Error: Framer Motion animation doesn't trigger on scroll**
- `whileInView` only works if the element is not already in view on mount.
- Fix: Use `viewport={{ once: true, amount: 0.3 }}` to trigger once when 30% visible.

**Error: D3 scale domain is undefined**
- If `data` is empty or undefined when the chart renders, `d3.extent()` returns `[undefined, undefined]`.
- Fix: Always guard with `if (!data || data.length === 0) return;` at the top of `useEffect`.

**Error: Calendar Heatmap cells misaligned**
- D3 `d3.timeWeek` starts weeks on Sunday by default. Brazilian convention is Monday.
- Fix: Use `d3.timeMonday` instead of `d3.timeWeek`.

**Error: Climate Stripes color scale is wrong**
- The baseline for the diverging scale must be the 1940–1980 mean, NOT the full dataset mean.
- Fix: Filter data to 1940–1980 to compute baseline before creating the scale.

**Error: TypeScript complains about D3 selection types**
- D3's TypeScript types are complex. Use `as SVGSVGElement` casts where needed.
- Or: use `.js` extension for D3-heavy files and add `// @ts-nocheck` at top.

**Error: `npm run build` fails with "Cannot find module 'scrollama'"`**
- Scrollama is a CommonJS module. Vite may need explicit config.
- Fix in `vite.config.js`:
  ```js
  optimizeDeps: { include: ['scrollama'] }
  ```

**Error: GitHub Pages shows 404 on refresh**
- GitHub Pages doesn't support client-side routing by default.
- Fix: Add a `public/404.html` that redirects to `index.html` with the path encoded as a query param. Add corresponding script in `index.html`.
- Or: Use hash-based routing (`/#/section`) instead of path-based.

### PowerShell / Windows Gotchas
- `npx -y shadcn@latest init --defaults --yes` may fail due to PowerShell execution policy.
  - Fix: Use Git Bash instead of PowerShell for npm/npx commands.
- If `npm install` fails with lock file errors: delete `package-lock.json` and `node_modules/`, then retry.
- Python scripts use forward slashes in paths. On Windows, use `pathlib.Path` instead of string concatenation.
  ```python
  from pathlib import Path
  RAW_DIR = Path('data/raw')  # Works on both Windows and Unix
  ```

---

## 4. Edge Cases and Gotchas

### Data Edge Cases

**Leap years**: February 29 exists in some years. The date reindex must use `freq='D'` (not `freq='365D'`). Always use `pd.date_range` with `freq='D'`.

**Year 1940**: ERA5 data quality is lower before 1950. Consider adding a disclaimer in the UI for pre-1950 data.

**Missing entire years**: If an API call fails for a full year, the merge will have a 365-day gap. The interpolation guard (>3 days = flag) will catch this. Do NOT silently interpolate a full year.

**Precipitation = NaN vs 0**: A missing precipitation value is different from "no rain". Never replace NaN precipitation with 0. Use interpolation or flag.

**Heat wave spanning month boundary**: The `calculate_heat_waves` function works on the full year array, so month boundaries don't break it. But if you ever process by month, be careful.

**First/last hot day when no hot days exist**: If a year has zero days ≥30°C (unlikely but possible in early records), `first_hot_day` and `last_hot_day` should be `null`, not 0 or NaN.

**Percentile calculation uses full historical baseline**: The 90th/95th percentile is computed from the FULL 1940–2024 T_max distribution, not per-year. Recomputing it per year would defeat the purpose.

### Frontend Edge Cases

**Year 1940 has only partial data**: Open-Meteo ERA5 starts Jan 1, 1940, but the first few months may have lower quality. The Calendar Heatmap for 1940 may show some missing cells.

**User selects same year in YearSelector**: Year A = Year B. All comparison cells should show "—" or 0 difference, not NaN.

**ThresholdSlider at extreme values**: At 35°C threshold, most years will show 0 days. The chart y-axis must handle 0 gracefully (don't divide by zero for trend line).

**PersonalTimeline with birth year = current year**: Only 1 year of data. Show a message instead of a chart.

**Mobile: Scrollama sticky positioning**: `position: sticky` doesn't work inside `overflow: hidden` containers. Never set `overflow: hidden` on a Scrollama parent.

**D3 and React StrictMode**: React 18 StrictMode double-invokes effects. D3 charts will draw twice, causing duplicate elements. Fix: Clear SVG at the start of every `useEffect`.

**Large dataset in memory**: 31,000 daily records × 7 fields ≈ 217,000 values in memory. This is fine for modern browsers. Do NOT try to process this in a Web Worker unless profiling shows a real bottleneck.

**Gzipped JSON**: If `climate_data.json.gz` is served, the browser decompresses it automatically if the server sets `Content-Encoding: gzip`. GitHub Pages does NOT set this header for pre-compressed files. Use uncompressed JSON, or use the Vite compression plugin to compress at build time.

### Deployment Edge Cases

**GitHub Pages base path**: The `base` in `vite.config.js` MUST match the repository name exactly (case-sensitive). If the repo is `Pindamonhangaba-Climate`, the base must be `/Pindamonhangaba-Climate/`.

**GitHub Actions permissions**: The `deploy.yml` workflow requires `permissions: pages: write, id-token: write` at the job level, NOT just the workflow level.

**Annual data refresh**: The scheduled GitHub Action (`cron: '0 6 1 1 *'`) runs Python scripts to fetch new data. The Python environment must be set up in the workflow (install requirements.txt). The new JSON files must be committed back to the repo OR uploaded as build artifacts.

**Cache busting**: After data updates, browsers may serve stale `climate_data.json` from cache. Add a version query param or use content hashing in the filename.

---

## 5. Technology Reference

### Key Library APIs

**D3.js v7**
- `d3.scaleSequential(d3.interpolateRdYlBu).domain([10, 40])` — temperature color scale
- `d3.scaleSequential(d3.interpolatePRGn).domain([-2, 2])` — anomaly diverging scale
- `d3.extent(data, d => d.temp_max)` — get [min, max]
- `d3.timeMonday` — week starts on Monday (Brazilian convention)
- `d3.select(ref.current).selectAll('*').remove()` — clear SVG before redraw

**Scrollama**
```js
import scrollama from 'scrollama';
const scroller = scrollama();
scroller.setup({ step: '.step', offset: 0.5 })
  .onStepEnter(({ index, direction }) => { /* update state */ })
  .onStepExit(({ index, direction }) => { /* update state */ });
// Must call scroller.resize() on window resize
```

**Framer Motion**
```jsx
<motion.div
  initial={{ opacity: 0, y: 20 }}
  whileInView={{ opacity: 1, y: 0 }}
  viewport={{ once: true, amount: 0.3 }}
  transition={{ duration: 0.6 }}
/>
```

**Recharts**
```jsx
<ResponsiveContainer width="100%" height={400}>
  <LineChart data={annualData}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis dataKey="year" />
    <YAxis />
    <Tooltip />
    <Legend />
    <Line type="monotone" dataKey="hd30" stroke="#dc2626" dot={false} />
    <Brush dataKey="year" height={30} />
  </LineChart>
</ResponsiveContainer>
```

**Open-Meteo API**
```python
import requests
response = requests.get(
    'https://archive-api.open-meteo.com/v1/archive',
    params={
        'latitude': -22.9250,
        'longitude': -45.4620,
        'start_date': '2024-01-01',
        'end_date': '2024-12-31',
        'daily': 'temperature_2m_max,temperature_2m_min,temperature_2m_mean,precipitation_sum,relative_humidity_2m_mean,windspeed_10m_max',
        'timezone': 'America/Sao_Paulo'
    },
    timeout=30
)
response.raise_for_status()
data = response.json()
```

### shadcn/ui Conventions
- Components live in `src/components/ui/` — generated by `npx shadcn add <component>`
- **Never** edit files in `src/components/ui/` directly if you plan to re-run shadcn add. Instead, wrap or extend them in `src/components/common/` or feature folders.
- shadcn uses `cn()` utility from `src/lib/utils.ts` — always import from there, never inline `clsx`.
- shadcn/ui requires `@/` path alias pointing to `src/`. Verify `tsconfig.json` has `"paths": { "@/*": ["./src/*"] }` and `vite.config.ts` has `resolve.alias`.
- To add a shadcn component: `npx shadcn add button` (use Git Bash on Windows).

### Tailwind CSS v4 Conventions
- **No `tailwind.config.js`** — Tailwind v4 uses a CSS-first config via `@theme {}` in `src/index.css`.
- **No `@tailwind base/components/utilities`** — replaced by `@import "tailwindcss"`.
- **Vite plugin** replaces PostCSS plugin: add `tailwindcss()` to `vite.config.ts` plugins, NOT to `postcss.config.js`.
- Custom colors defined in `@theme {}` are automatically available as Tailwind utilities: `--color-temp-hot: #ef8a62` → `bg-temp-hot`, `text-temp-hot`.
- **Dark mode**: Use `@variant dark` in CSS or `dark:` prefix in JSX. Set `darkMode: 'class'` equivalent via `@custom-variant dark (&:where(.dark, .dark *))`.

### TypeScript Conventions
- All component files use `.tsx` extension.
- All non-component TS files use `.ts` extension.
- Strict mode enabled (`"strict": true` in tsconfig).
- Data types defined in `src/types/climate.ts` — import from there, never inline.
- D3 selections: use `d3.Selection<SVGSVGElement, unknown, null, undefined>` types. Cast with `as SVGSVGElement` where needed.
- For D3 refs: `const svgRef = useRef<SVGSVGElement>(null)`.

### Vite Config Template
```ts
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import path from 'path'

export default defineConfig({
  plugins: [react(), tailwindcss()],
  base: '/pindamonhangaba-climate/',
  resolve: { alias: { '@': path.resolve(__dirname, './src') } },
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    rollupOptions: {
      output: {
        manualChunks: {
          d3: ['d3'],
          recharts: ['recharts'],
          leaflet: ['leaflet', 'react-leaflet']
        }
      }
    }
  },
  optimizeDeps: { include: ['scrollama'] }
})
```

### Python Data Path Pattern
```python
from pathlib import Path

ROOT = Path(__file__).parent.parent  # data/scripts/ -> project root
RAW_DIR = ROOT / 'data' / 'raw'
PROCESSED_DIR = ROOT / 'data' / 'processed'
PUBLIC_DATA_DIR = ROOT / 'public' / 'data'

RAW_DIR.mkdir(parents=True, exist_ok=True)
PROCESSED_DIR.mkdir(parents=True, exist_ok=True)
PUBLIC_DATA_DIR.mkdir(parents=True, exist_ok=True)
```

---

## 6. Windows Terminal / npx Issues

- **Use Git Bash** for commands like `npx -y shadcn@latest init --defaults --yes`. PowerShell's execution policy often blocks npx scripts from running.
- If PowerShell is required, use `cmd.exe` as a fallback instead: `cmd /c "npx -y shadcn@latest init --defaults --yes"`.
- **npm lock file conflicts:** If an `npm install` or `npx` command hangs or fails due to a stale lock file, delete `package-lock.json` and the `node_modules` folder, then retry:
  ```powershell
  Remove-Item -Recurse node_modules; Remove-Item package-lock.json; npm install
  ```

---

## 7. Attribution Requirements

The following attributions MUST appear in the Footer and README:

```
Climate data: Open-Meteo (https://open-meteo.com/) — ERA5 reanalysis via Copernicus/ECMWF
Visualization inspired by Ed Hawkins' Climate Stripes (https://showyourstripes.info/)
Map tiles: © OpenStreetMap contributors
```

License:
- Code: MIT
- Data: CC BY 4.0 (with above attribution)
- Content/text: CC BY-SA 4.0
