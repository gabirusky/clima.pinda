# CONTEXT.md — *A City's Memory of Heat*
### Pindamonhangaba Climate Visualization

> Reference document for the coding agent: design language, conventions, domain knowledge, common errors, and gotchas.

---

## 1. Project-Specific Conventions

### Tech Stack (Frontend)
| Technology | Version | Purpose |
|------------|---------|---------|
| React | 18 | UI framework |
| Vite | 5+ | Build tooling |
| TypeScript | 5+ | Type safety (strict mode) |
| shadcn/ui | latest | Component library (Radix + Tailwind, code-owned) |
| Tailwind CSS | **4** | Utility-first CSS (CSS-first config, no tailwind.config.js) |
| D3.js | v7 | Complex visualizations (stripes, ridgeline, calendar heatmap) |
| Recharts | 2+ | Simple charts (time series, bar) |
| Framer Motion | 11+ | Scroll-triggered animations |
| Scrollama | 3+ | Scrollytelling step management |
| Leaflet | 1.9+ | Interactive map |

### File Naming
- Python scripts: `snake_case.py`
- React components: `PascalCase.tsx`
- Hooks: `useCamelCase.ts`
- Utilities: `camelCase.ts`
- CSS files: `kebab-case.css`
- Data files: `snake_case.json` / `snake_case.csv`

### Directory Ownership
- `data/scripts/` — Python only. No JS here.
- `src/` — React/TypeScript only. No Python here.
- `public/data/` — JSON files consumed by the frontend. Generated by Python scripts. Do NOT hand-edit.
- `data/raw/` — Raw API responses. Gitignored. Never commit.
- `data/processed/` — Cleaned CSVs. Gitignored. Never commit.

### Component Props Convention
- All visualization components accept a `data` prop as their primary data source.
- All components that need a year filter accept a `year` prop (number, e.g., `2024`).
- All components that need metric selection accept an `activeMetric` prop (string key).
- Callbacks are named `onXxx` (e.g., `onYearChange`, `onStepEnter`).

### Data Shape Contracts
```ts
// Daily record (from climate_data.json)
{ date: "1985-01-15", temp_max: 32.1, temp_min: 18.4, temp_mean: 24.2,
  precipitation: 0.0, humidity: 65.3, wind_max: 12.1 }

// Annual metrics (from metrics.json, keyed by year)
{ su25: 210, su30: 112, tr20: 87, dtr_mean: 12.3,
  temp_max_mean: 28.4, temp_min_mean: 16.1, temp_mean_annual: 22.1,
  precip_total: 1234.5, precip_days: 98,
  wsdi_days: 18,    // WSDI — percentile-based warm spell days
  tx90p: 14.2,      // TX90p — % warm days above p90 baseline
  tn90p: 11.8,      // TN90p — % warm nights above p90 baseline
  cdd: 42, cwd: 12,
  gdd: 4521.3, p95_days: 18,
  first_hot_day: 45, last_hot_day: 320, hot_season_length: 275,
  anomaly: 1.2 }    // deviation from 1940–1980 baseline mean

// Summary (from summary.json)
{ hottest_day: {date, temp_max, temp_min},
  coldest_day: {date, temp_min},
  wettest_day: {date, precipitation},
  longest_warm_spell: {year, days},   // WSDI record
  year_most_su30: {year, su30},
  su30_trend_slope_per_decade: 7.09,
  decade_comparison: { "1940s": {...}, "2020s": {...} },
  temp_anomaly_by_year: { 1940: -0.4, ..., 2024: 1.2 } }
```

### CSS Conventions
- Use CSS custom properties from `src/index.css` `@theme {}` — never hardcode colors or spacing.
- Use Tailwind utility classes for layout (flex, grid, padding, margin).
- Use custom CSS for animations and complex visual effects (`src/index.css` keyframes).
- Never use inline styles except for D3-computed values (x, y, width, height, fill).
- All animation keyframes live in `src/index.css` — not in component files.

### Import Order (JS files)
1. React imports
2. Third-party libraries (d3, recharts, framer-motion)
3. Internal hooks
4. Internal components
5. Internal utils/constants
6. CSS imports (last)

---

## 2. Design Language — "A City's Memory of Heat"

> This section defines the visual and motion language that every component must follow. Treat it as the aesthetic contract.

### Core Metaphor
Time is geological strata. Scrolling down = drilling deeper into the past. Scrolling back up = rising toward the scorching present. The color temperature of the *page itself* changes with scroll position.

### Typography
| Role | Font | Size | Usage |
|------|------|------|-------|
| Display / Key stats | **Syne** 800 | 120–160px (CSS clamp) | `+2.4°C`, `140 DAYS` — physical weight |
| Section headlines | **Syne** 700 | 48–96px | Chapter titles |
| Body copy | **DM Sans** 400–500 | 1.125rem | Prose, captions, annotations |
| Calculator / data tables | **JetBrains Mono** | 0.9rem | Receipt-style layout |

> **Never** use Inter, Roboto, Arial, or system fonts. They break the aesthetic.

### Color Tokens (defined in `src/index.css` `@theme {}`)
```css
--color-base: #0a0f1e;             /* Deep navy void */
--color-stripe-deep-cold: #08306b;
--color-stripe-cold: #2166ac;
--color-stripe-cool: #4393c3;
--color-stripe-neutral: #f7f7f7;
--color-stripe-warm: #ef8a62;
--color-stripe-hot: #d6604d;
--color-stripe-burning: #b2182b;
--color-stripe-extreme: #67001f;
--color-text-primary: #f0ece3;     /* Off-white, warm */
--color-text-secondary: #a09080;
--color-text-accent: #ef8a62;      /* Hot orange callouts */
```

### Scroll-Driven Background
The full-page background gradient shifts from cool to hot as the user scrolls toward recent data. Implement via `useScrollProgress` hook + CSS custom property `--scroll-heat` on `document.documentElement`.

### Animation Standards
| Component | Animation | Duration |
|-----------|-----------|----------|
| Climate Stripes | Left-to-right stagger reveal, 8ms/stripe | ~700ms total |
| Ridgeline decades | Reveal oldest → newest, one at a time | 300ms each |
| Calendar Heatmap cells | Fill day-by-day (chronological timelapse) | 2ms/day |
| Bar charts | Bars grow from baseline | 20ms/bar |
| Number callouts | Count-up from 0 | 1200ms ease-out |
| Section entrance | opacity 0→1, y 32→0 | 800ms |

**Standard Framer Motion pattern**:
```tsx
<motion.div
  initial={{ opacity: 0, y: 32 }}
  whileInView={{ opacity: 1, y: 0 }}
  viewport={{ once: true, amount: 0.3 }}
  transition={{ duration: 0.8, ease: [0.22, 1, 0.36, 1] }}
/>
```

**Standard D3 transition**:
```js
selection.transition().duration(600).ease(d3.easeCubicOut)
```

**`prefers-reduced-motion`**: All animations must degrade to instant state changes:
```css
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}
```

### AC Calculator Layout
- JetBrains Mono throughout — no exceptions
- Two columns: left label, right value, right-aligned
- `TOTAL:` row: hairline rule above (`border-top: 1px solid var(--color-text-secondary)`)
- Final cost value: `--color-text-accent`, blinks once with `pulseHot` keyframe
- No decorative elements — starkness **is** the design

### Personal Timeline Widget
On birth-year submit, the section transitions register:
- All typography scales *down* (smaller, more intimate)
- Background softens (slightly lighter surface)
- Chart: sparse, annotated, no gridlines
- Reads like a private record, not a dashboard

---

## 3. Domain Knowledge

### Climate Metrics Definitions

> **ETCCDI Alignment**: All indices are defined according to, or are direct adaptations of, the Expert Team on Climate Change Detection and Indices (ETCCDI) 27-index standard ([etccdi.pacificclimate.org](http://etccdi.pacificclimate.org/list_27_indices.shtml)).

| Metric | ETCCDI Index | Full Name | Definition |
|--------|-------------|-----------|------------|
| SU25 | SU25 ✅ exact | Summer Days | Days where T_max ≥ 25°C |
| SU30 | SU30 (modified) | Hot Days | Days where T_max ≥ 30°C (locally meaningful threshold) |
| TR20 | TR20 ✅ exact | Tropical Nights | Nights where T_min ≥ 20°C |
| DTR | DTR ✅ exact | Diurnal Temperature Range | Mean(T_max − T_min) per year |
| WSDI | WSDI ✅ exact | Warm Spell Duration Index | Days in warm spells: ≥6 consecutive days with T_max > calendar-day p90 (1961–1990 baseline) |
| TX90p | TX90p ✅ exact | Warm Days | % of days where T_max > calendar-day p90 of baseline |
| TN90p | TN90p ✅ exact | Warm Nights | % of nights where T_min > calendar-day p90 of baseline |
| CDD | CDD ✅ exact | Consecutive Dry Days | Max consecutive days with precipitation < 1mm |
| CWD | CWD ✅ exact | Consecutive Wet Days | Max consecutive days with precipitation ≥ 1mm |
| GDD | — | Growing Degree Days | SUM(MAX(0, (T_max+T_min)/2 − 10)) per year |
| P95 | — | 95th Percentile Days | Days above 95th percentile of full historical T_max |

> **DTR note (ERA5-specific)**: The trend for Pindamonhangaba is **+0.11°C/decade (increasing)** — daytime T_max warming faster than nocturnal T_min. ERA5 doesn't model the urban canopy, so this reflects daytime warming dominating the rural grid cell, not a UHI signal.

### Open-Meteo API
- **Base URL**: `https://archive-api.open-meteo.com/v1/archive`
- **Coordinates**: lat=-22.9250, lon=-45.4620 (Praça Monsenhor Marcondes, Pindamonhangaba)
- **Timezone**: Always use `America/Sao_Paulo` — otherwise dates shift by 3 hours
- **Rate limit**: ~10,000 calls/day on free tier
- **ERA5 data starts**: 1940-01-01
- **Data lag**: Most recent ~5 days may be missing (reanalysis not yet finalized)

### ERA5 Reanalysis
- ERA5 is a **reanalysis** product — historical observations + climate model. Not raw station data.
- Temperatures may be **systematically 1–2°C lower** than ground station in urban areas (no UHI in model).
- Do NOT mix ERA5 data with INMET station data without bias correction.

### ERA5 vs MERRA-2 Cross-Validation (completed)
- **Results** (10 years, 3,653 records): r T_max=0.893, r T_min=0.926, RMSE T_max=1.75°C, RMSE T_min=1.98°C.
- **T_min warm bias (+1.51°C ERA5 > MERRA-2)**: Known, documented inter-reanalysis difference. ERA5's ~9km grid resolves Pindamonhangaba's nocturnal cold-air pooling better than MERRA-2's ~50km grid. NOT a bug.

### Pindamonhangaba Geography
- Located in the Paraíba Valley (Vale do Paraíba), São Paulo state, Brazil
- Altitude: ~550m (valley floor). Surrounded by Serra da Mantiqueira (north) and Serra do Mar (south)
- Valley topography creates temperature inversions — nights can be cooler than surrounding hills
- Urban area: ~170,000 inhabitants (2024). Climate: Cwa (humid subtropical, dry winter) per Köppen

### Temperature Thresholds (Brazil Context)
- **30°C** = "hot day" threshold in Brazilian public health literature
- **32°C** = heat stress threshold for outdoor workers (NR-15 reference)
- **20°C T_min** = "tropical night" — uncomfortable for sleep without AC
- **25°C** = residential AC usage threshold

### Color Scale Rules
- **Climate Stripes baseline**: 1940–1980 mean. **Not** the full dataset mean. **Not** 1961–1990.
- **Temperature heatmap**: `d3.interpolateRdYlBu` reversed, domain [10°C, 40°C]
- **Week start**: `d3.timeMonday` (Brazilian convention — not `d3.timeWeek`)
- **Colorblind safety**: Viridis alternative always available

---

## 4. Common Agent Errors

### Python Data Pipeline

**Error: API returns empty data for early years**
- ERA5 starts at 1940-01-01. Clamp `start_date` to `max(start_date, '1940-01-01')`.

**Error: Missing days after merge**
```python
full_index = pd.date_range('1940-01-01', '2025-12-31', freq='D')
df = df.set_index('date').reindex(full_index).reset_index()
df.rename(columns={'index': 'date'}, inplace=True)
```

**Error: T_min > T_max on some days**
```python
mask = df['temp_min'] > df['temp_max']
df.loc[mask, ['temp_min', 'temp_max']] = df.loc[mask, ['temp_max', 'temp_min']].values
```

**Error: `gdd` returns negative values**
- `MAX(0, ...)` must be applied per day before summing:
```python
df['gdd_daily'] = np.maximum(0, (df['temp_max'] + df['temp_min'])/2 - 10)
```

**Error: JSON file too large (>500KB)**
- Daily records: ~31K rows × ~100 bytes ≈ 3MB uncompressed. Round floats to 1dp. Use gzip.
- `climate_data.json.gz` (auto-compressed): 4.3MB → 425KB.

**Error: Year 2002 gap**
- Resolved: re-fetching `fetch_year(2002)` returned all 365 days. Dataset is complete (31,412 rows). No special handling needed.

### React / D3 Frontend

**Error: D3 chart doesn't update when props change**
```js
useEffect(() => {
  d3.select(svgRef.current).selectAll('*').remove(); // always clear first
  // ... draw
}, [data, year]);
```

**Error: Leaflet map renders as grey box**
```js
import 'leaflet/dist/leaflet.css';  // MUST be imported in the component
```

**Error: Scrollama doesn't trigger on mobile**
- Step elements must have `min-height: 100vh`.

**Error: `useClimateData` fetches wrong path on GitHub Pages**
```ts
const res = await fetch(`${import.meta.env.BASE_URL}data/climate_data.json`);
```

**Error: Climate Stripes color scale uses wrong baseline**
- Filter data to 1940–1980 to compute baseline BEFORE creating the diverging scale. Never use full dataset mean.

**Error: Calendar Heatmap cells misaligned**
- Use `d3.timeMonday` (not `d3.timeWeek`). Brazilian weeks start on Monday.

**Error: Framer Motion animation doesn't trigger on scroll**
```tsx
// Use viewport.once + amount to trigger correctly
viewport={{ once: true, amount: 0.3 }}
```

**Error: `npm run build` fails with "Cannot find module 'scrollama'"**
```js
// vite.config.ts
optimizeDeps: { include: ['scrollama'] }
```

**Error: GitHub Pages shows 404 on refresh**
- Add `public/404.html` redirecting to `index.html`. Or use hash routing (`/#/section`).

### Design-Specific Errors

**Error: Animations pop in instead of reveal slowly**
- All chart entrances must be scroll-triggered, not instant. Use `whileInView` + Framer Motion or D3 transition with `duration(600)`. Never set `duration: 0`.

**Error: Colors don't match Ed Hawkins palette**
- Do not generate your own blue-to-red gradient. Use the exact tokens from `@theme {}` in `src/index.css`.

**Error: Body text uses a generic font**
- Never use Inter, Roboto, or Arial. DM Sans for body, Syne for display, JetBrains Mono for calculator/data.

**Error: Key statistics are too small**
- Stats like `+2.4°C`, `140 DAYS` must use `--text-display-xl` (clamped 80–160px). If a stat can be read at arm's length without squinting, it's too small.

**Error: AC Calculator uses a decorative layout**
- The calculator is a receipt. JetBrains Mono. Two columns only. Starkness is the design.

---

## 5. Edge Cases and Gotchas

### Data Edge Cases

**Leap years**: Always use `pd.date_range(..., freq='D')` — never `freq='365D'`.

**Year 1940**: ERA5 quality is lower before 1950. Add a UI disclaimer for pre-1950 data.

**Missing entire years**: If API call fails for a full year, a 365-day gap will be flagged (gaps >3 days are not silently interpolated). Never silently fill a full-year gap.

**Precipitation = NaN vs 0**: Missing is not "no rain." Never replace NaN precipitation with 0.

**Heat wave spanning year boundary**: `calculate_heat_waves` processes each year independently — a Dec 30–Jan 3 heat wave is split. Acceptable limitation; document in comments.

**Percentile calculation uses 1961–1990 baseline**: TX90p/TN90p use calendar-day p90 from the 1961–1990 baseline only. The scalar p95 threshold for `p95_days` uses the full 1940–2025 T_max distribution. These are intentionally different baselines.

**Anomaly column uses 1940–1980 baseline**: To match Climate Stripes convention.

### Frontend Edge Cases

**Year 1940 Calendar Heatmap**: May show missing cells in early months. Expected — low ERA5 quality.

**User selects same year in YearSelector**: Show "—" or Δ=0, not NaN.

**ThresholdSlider at 35°C**: Most years → 0 days. Y-axis and trend line must handle 0 gracefully.

**PersonalTimeline with birth year = current year**: Only 1 year of data. Show a message, not a chart.

**Mobile: Scrollama sticky positioning**: Never set `overflow: hidden` on a Scrollama parent. It breaks `position: sticky`.

**D3 + React StrictMode**: StrictMode double-invokes effects. D3 charts draw twice → duplicate elements. Fix: always clear SVG at the start of every `useEffect`.

**Large dataset in memory**: 31,000 records × 7 fields ≈ 217,000 values. Fine for modern browsers. Don't use a Web Worker unless profiling reveals a real bottleneck.

**Gzipped JSON on GitHub Pages**: GitHub Pages does NOT set `Content-Encoding: gzip` for pre-compressed files. Use the Vite compression plugin to compress at build time, or serve uncompressed.

---

## 6. Technology Reference

### D3.js v7 Key APIs
```js
d3.scaleSequential(d3.interpolateRdYlBu).domain([10, 40]) // temp heatmap (reversed)
d3.scaleSequential(d3.interpolatePRGn).domain([-2, 2])    // anomaly diverging
d3.extent(data, d => d.temp_max)                           // [min, max]
d3.timeMonday                                              // Brazilian week start
d3.select(ref.current).selectAll('*').remove()             // clear before redraw
```

### Scrollama
```js
import scrollama from 'scrollama';
const scroller = scrollama();
scroller.setup({ step: '.step', offset: 0.5 })
  .onStepEnter(({ index, direction }) => { /* update state */ })
  .onStepExit(({ index, direction }) => { /* update state */ });
// Must call scroller.resize() on window resize
```

### Framer Motion
```tsx
<motion.div
  initial={{ opacity: 0, y: 32 }}
  whileInView={{ opacity: 1, y: 0 }}
  viewport={{ once: true, amount: 0.3 }}
  transition={{ duration: 0.8, ease: [0.22, 1, 0.36, 1] }}
/>
```

### Recharts
```tsx
<ResponsiveContainer width="100%" height={400}>
  <LineChart data={annualData}>
    <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
    <XAxis dataKey="year" stroke="var(--color-text-secondary)" />
    <YAxis stroke="var(--color-text-secondary)" />
    <Tooltip contentStyle={{ background: '#0a0f1e', border: '1px solid #333' }} />
    <Line type="monotone" dataKey="su30" stroke="var(--color-stripe-hot)" dot={false} />
  </LineChart>
</ResponsiveContainer>
```

### Vite Config Template
```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import path from 'path'

export default defineConfig({
  plugins: [react(), tailwindcss()],
  base: '/pindamonhangaba-climate/',
  resolve: { alias: { '@': path.resolve(__dirname, './src') } },
  build: {
    outDir: 'dist',
    rollupOptions: {
      output: {
        manualChunks: {
          d3: ['d3'],
          recharts: ['recharts'],
          leaflet: ['leaflet', 'react-leaflet']
        }
      }
    }
  },
  optimizeDeps: { include: ['scrollama'] }
})
```

### Python Data Path Pattern
```python
from pathlib import Path

ROOT = Path(__file__).parent.parent.parent  # data/scripts/ → project root
RAW_DIR = ROOT / 'data' / 'raw'
PROCESSED_DIR = ROOT / 'data' / 'processed'
PUBLIC_DATA_DIR = ROOT / 'public' / 'data'

RAW_DIR.mkdir(parents=True, exist_ok=True)
PROCESSED_DIR.mkdir(parents=True, exist_ok=True)
PUBLIC_DATA_DIR.mkdir(parents=True, exist_ok=True)
```

### shadcn/ui Conventions
- Components live in `src/components/ui/` — generated by `npx shadcn add <component>`
- Never edit `src/components/ui/` directly if you plan to re-run `shadcn add`. Wrap in `src/components/common/`.
- Always import `cn()` from `src/lib/utils.ts`.
- `@/` path alias must point to `src/` in both `tsconfig.json` and `vite.config.ts`.

### Tailwind CSS v4 Conventions
- **No `tailwind.config.js`** — v4 uses `@theme {}` in `src/index.css`
- **No `@tailwind base/components/utilities`** — replaced by `@import "tailwindcss"`
- **Vite plugin** replaces PostCSS plugin: add `tailwindcss()` in `vite.config.ts` plugins
- Custom color tokens in `@theme {}` are auto-available as Tailwind utilities: `--color-stripe-hot` → `bg-stripe-hot`, `text-stripe-hot`

---

## 7. Attribution Requirements

The following attributions MUST appear in the Footer and README:

```
Climate data: Open-Meteo (https://open-meteo.com/) — ERA5 reanalysis via Copernicus/ECMWF
Visualization inspired by Ed Hawkins' Climate Stripes (https://showyourstripes.info/)
Map tiles: © OpenStreetMap contributors
```

License:
- Code: MIT
- Data: CC BY 4.0 (with above attribution)
- Content/text: CC BY-SA 4.0
